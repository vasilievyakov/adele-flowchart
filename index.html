<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Карта процессов салона ADELE – интерактивная версия</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        /* Базовые стили */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow: hidden;
        }
        /* Контейнер для основной карты и мини-карты */
        #container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }
        /* Основной SVG занимает всю доступную площадь */
        svg#mainSvg {
            width: 100%;
            height: 100%;
            cursor: grab;
        }
        svg#mainSvg.dragging {
            cursor: grabbing;
        }
        /* Мини‑карта отображается в правом нижнем углу */
        svg#minimapSvg {
            position: fixed;
            right: 20px;
            bottom: 20px;
            width: 220px;
            height: 150px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 6px;
            background: rgba(255,255,255,0.8);
            z-index: 800;
        }
        /* Панель управления */
        .controls {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-width: 300px;
        }
        .controls h3 {
            color: #333;
            font-size: 16px;
            margin-bottom: 8px;
        }
        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        button:active {
            transform: translateY(0);
        }
        button.active {
            background: linear-gradient(135deg, #f093fb, #f5576c);
        }
        .zoom-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .zoom-controls button {
            width: 40px;
            height: 40px;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }
        #zoomLabel {
            font-size: 14px;
            color: #333;
            margin-left: 4px;
        }
        /* Статистика процесса */
        .stats {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: white;
            padding: 12px 16px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            font-size: 13px;
            line-height: 1.4;
            z-index: 1000;
        }
        /* Легенда типов узлов */
        .legend {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 12px 16px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            font-size: 13px;
            z-index: 1000;
            max-width: 200px;
        }
        .legend h4 {
            margin-bottom: 10px;
            color: #333;
            font-size: 14px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
            font-size: 12px;
        }
        .legend-color {
            width: 18px;
            height: 18px;
            margin-right: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        /* Подсказка (tooltip) */
        .tooltip {
            position: fixed;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 12px;
            border-radius: 8px;
            font-size: 12px;
            max-width: 300px;
            pointer-events: none;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s ease;
            line-height: 1.4;
        }
        .tooltip.show {
            opacity: 1;
        }
        /* Стили для узлов и рёбер */
        .node {
            cursor: pointer; /* Добавляем курсор для узлов */
        }
        .node rect, .node polygon {
            stroke: transparent;
        }
        .node text {
            pointer-events: none;
            user-select: none;
            text-shadow: 0px 0px 4px rgba(0,0,0,0.7);
        }
        .edge {
            fill: none;
        }
        .edge-label {
            font-size: 12px;
            font-weight: bold;
            fill: white;
            pointer-events: none;
            user-select: none;
            paint-order: stroke;
            stroke: #667eea;
            stroke-width: 8px;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        /* Подсветка выбранного пути */
        .node.highlight rect, .node.highlight polygon {
            stroke: #f093fb;
            stroke-width: 4px;
        }
        .edge.highlight {
            stroke: #f093fb !important;
            stroke-width: 3px;
        }
    </style>
</head>
<body>
    <div class="controls">
        <h3>Управление картой</h3>
        <div class="btn-group">
            <button id="resetBtn">Сброс вида</button>
            <button id="animBtn">Анимация</button>
        </div>
        <div class="zoom-controls">
            <button id="zoomInBtn">+</button>
            <span id="zoomLabel">100%</span>
            <button id="zoomOutBtn">−</button>
        </div>
        <div class="btn-group">
            <button data-role="all" class="active">Все процессы</button>
            <button data-role="designer">Дизайнер</button>
            <button data-role="admin">Администратор</button>
            <button data-role="owner">Руководитель</button>
            <button data-role="accountant">Бухгалтер</button>
            <button data-role="external">Внешний подрядчик</button>
            <button data-role="driver">Водитель‑логист</button>
        </div>
    </div>
    <div class="legend">
        <h4>Легенда</h4>
        <div class="legend-item"><div class="legend-color" style="background: linear-gradient(135deg, #667eea, #764ba2);"></div> Начало/Конец</div>
        <div class="legend-item"><div class="legend-color" style="background: linear-gradient(135deg, #f093fb, #f5576c);"></div> Точка решения</div>
        <div class="legend-item"><div class="legend-color" style="background: linear-gradient(135deg, #4facfe, #00f2fe);"></div> Действие</div>
        <div class="legend-item"><div class="legend-color" style="background: linear-gradient(135deg, #43e97b, #38f9d7);"></div> Документ</div>
        <div class="legend-item"><div class="legend-color" style="background: linear-gradient(135deg, #fa709a, #fee140);"></div> Контроль</div>
    </div>
    <div class="stats" id="stats"></div>
    <div id="container">
        <svg id="mainSvg"></svg>
        <svg id="minimapSvg"></svg>
    </div>
    <div class="tooltip" id="tooltip"></div>
    <script>
    (function() {
        // Данные узлов и связей
        const nodes = [
            {id: 'start', x: 100, y: 300, text: 'Клиент обратился', type: 'start', role: 'all', 
             details: 'Клиент приходит в салон или звонит. Начало всего процесса работы.'},
            {id: 'consult', x: 250, y: 300, text: 'Консультация', type: 'action', role: 'designer',
             details: 'Дизайнер выявляет потребности, показывает образцы, предлагает решения. Скидка 10% новому клиенту.'},
            {id: 'contact', x: 400, y: 300, text: 'Сбор контактов', type: 'document', role: 'designer',
             details: 'ФИО, телефон, email. Внесение в Курс-24. Отправка визитки.'},
            {id: 'decision1', x: 550, y: 300, text: 'Клиент заинтересован?', type: 'decision', role: 'designer'},
            {id: 'reject1', x: 550, y: 450, text: 'Запись в лиды', type: 'document', role: 'designer',
             details: 'Фиксация в чате КОНСУЛЬТАЦИИ/ЛИДЫ для последующей работы'},
            {id: 'measure', x: 700, y: 360, text: 'Выезд на замер', type: 'action', role: 'driver',
             details: 'Стоимость выезда 1500–3000 руб. Возвращается при заказе от 50000 руб. Работу выполняет водитель‑логист (замерщик‑монтажник).'},
            {id: 'project', x: 850, y: 300, text: 'Создание проекта', type: 'action', role: 'designer',
             details: 'Создание в Курс-24. Срок: 3 дня после замера'},
            {id: 'calc', x: 1000, y: 300, text: 'Расчет КП', type: 'document', role: 'designer',
             details: 'Запрос цен у поставщиков, расчет с наценками (пошив 35-200%, монтаж мин 45%)'},
            {id: 'visual', x: 1000, y: 200, text: 'Визуализация', type: 'document', role: 'designer',
             details: 'При необходимости создается визуализация проекта'},
            {id: 'send_kp', x: 1150, y: 300, text: 'Отправка КП клиенту', type: 'action', role: 'designer',
             details: 'Email или WhatsApp'},
            {id: 'decision2', x: 1300, y: 300, text: 'КП согласовано?', type: 'decision', role: 'designer'},
            {id: 'reject2', x: 1300, y: 450, text: 'Доработка КП', type: 'action', role: 'designer',
             details: 'Корректировка предложения по замечаниям клиента'},
            {id: 'order', x: 1450, y: 300, text: 'Оформление заказа', type: 'action', role: 'designer',
             details: 'Создание заказа в Курс-24, присвоение номера'},
            {id: 'blank', x: 1600, y: 300, text: 'Заполнение БЗ', type: 'document', role: 'designer',
             details: 'Бланк заказа с артикулами, размерами, описанием пошива и монтажа'},
            {id: 'contract', x: 1600, y: 200, text: 'Договор', type: 'document', role: 'designer',
             details: 'При сумме от 25000 руб.'},
            {id: 'sign', x: 1750, y: 300, text: 'Подписание с клиентом', type: 'action', role: 'designer',
             details: 'Получение подписи или письменного согласования'},
            {id: 'prepay', x: 1900, y: 300, text: 'Прием предоплаты', type: 'control', role: 'designer',
             details: 'Стандарт 70%, минимум 50% для запуска. Касса, перевод или р/счет'},
            {id: 'decision3', x: 2050, y: 300, text: 'Предоплата ≥50%?', type: 'decision', role: 'admin'},
            {id: 'wait_pay', x: 2050, y: 450, text: 'Ожидание доплаты', type: 'action', role: 'admin',
             details: 'При предоплате 30% - только бронирование материалов'},
            {id: 'check_order', x: 2200, y: 300, text: 'Проверка заказа', type: 'control', role: 'admin',
             details: 'Администратор проверяет корректность всех данных'},
            {id: 'supplier_req', x: 2350, y: 300, text: 'Заявки поставщикам', type: 'action', role: 'admin',
             details: 'Отправка через Курс-24 в течение 2 дней после предоплаты'},
            {id: 'get_invoice', x: 2500, y: 300, text: 'Получение счетов', type: 'document', role: 'admin',
             details: 'Проверка наценки и цен'},
            {id: 'pay_invoice', x: 2650, y: 300, text: 'Оплата счетов', type: 'action', role: 'accountant',
             details: 'Бухгалтер оплачивает счета поставщикам'},
            {id: 'tz', x: 2200, y: 150, text: 'Составление ТЗ', type: 'document', role: 'designer',
             details: 'Техзадание для цеха в течение 3 дней. Размеры, описание пошива'},
            {id: 'send_tz', x: 2350, y: 150, text: 'Отправка в цех', type: 'action', role: 'admin',
             details: 'Передача ТЗ в пошивочный цех с указанием сроков'},
            {id: 'materials', x: 2800, y: 300, text: 'Получение материалов', type: 'control', role: 'admin',
             details: 'Подтверждение получения материалов цехом'},
            {id: 'production', x: 2950, y: 300, text: 'Производство', type: 'action', role: 'external',
             details: 'Пошив изделий согласно ТЗ. Срок: 10-20 дней'},
            {id: 'control_prod', x: 2950, y: 200, text: 'Контроль качества', type: 'control', role: 'admin',
             details: 'За 3 дня до срока - проверка готовности'},
            {id: 'ready', x: 3100, y: 300, text: 'Изделия готовы', type: 'control', role: 'designer',
             details: 'Проверка качества дизайнером, контроль на дефекты'},
            {id: 'confirm_date', x: 3250, y: 300, text: 'Согласование даты', type: 'action', role: 'admin',
             details: 'За 2 дня связь с клиентом, подтверждение времени'},
            {id: 'remind_pay', x: 3250, y: 200, text: 'Напоминание об оплате', type: 'document', role: 'admin',
             details: 'Информирование клиента об остатке к оплате'},
            {id: 'prepare', x: 3400, y: 360, text: 'Подготовка к выезду', type: 'action', role: 'driver',
             details: 'Сбор инструментов, печать документов. Выполняет водитель‑логист.'},
            {id: 'delivery', x: 3550, y: 360, text: 'Доставка/Монтаж', type: 'action', role: 'driver',
             details: 'Выезд на объект, монтаж карнизов, навеска штор. Зона ответственности водителя‑логиста.'},
            {id: 'final_pay', x: 3700, y: 300, text: 'Получение остатка', type: 'control', role: 'designer',
             details: 'Прием финальной оплаты от клиента'},
            {id: 'act', x: 3850, y: 300, text: 'Подписание актов', type: 'document', role: 'designer',
             details: 'Акт приема-передачи, отметка "Претензий не имею"'},
            {id: 'decision4', x: 4000, y: 300, text: 'Есть замечания?', type: 'decision', role: 'designer'},
            {id: 'fix', x: 4000, y: 450, text: 'Устранение замечаний', type: 'action', role: 'all',
             details: 'Доработка по претензиям клиента'},
            {id: 'review', x: 4150, y: 300, text: 'Запрос отзыва', type: 'action', role: 'designer',
             details: 'Предложение оставить отзыв'},
            {id: 'close', x: 4300, y: 300, text: 'Закрытие заказа', type: 'action', role: 'admin',
             details: 'Изменение статуса в Курс-24 на "Выполнен"'},
            {id: 'end', x: 4450, y: 300, text: 'Заказ завершен', type: 'end', role: 'all',
             details: 'Успешное завершение заказа. Документы в архив.'},
            {id: 'daily_control', x: 2500, y: 500, text: 'Ежедневный контроль', type: 'control', role: 'admin',
             details: 'Статусы заказов, касса, поступления'},
            {id: 'weekly_control', x: 2700, y: 500, text: 'Еженедельный контроль', type: 'control', role: 'owner',
             details: 'График монтажей, сроки производства, задолженности'},
            {id: 'monthly_control', x: 2900, y: 500, text: 'Ежемесячный отчет', type: 'control', role: 'owner',
             details: 'KPI, выручка, маржа, анализ рекламаций'},
            {id: 'crm', x: 400, y: 100, text: 'Ведение CRM', type: 'document', role: 'admin',
             details: 'Работа в Курс-24, обновление статусов'},
            {id: 'cash', x: 1900, y: 450, text: 'Кассовые операции', type: 'document', role: 'designer',
             details: 'Пробитие чека, запись в тетради, Z-отчет'},
            {id: 'archive', x: 4300, y: 450, text: 'Архивирование', type: 'document', role: 'admin',
             details: 'Сканы документов в Курс-24, физические в папки'}
        ];
        // Связи между узлами
        const edges = [
            {from: 'start', to: 'consult'},
            {from: 'consult', to: 'contact'},
            {from: 'contact', to: 'decision1'},
            {from: 'decision1', to: 'measure', label: 'Да'},
            {from: 'decision1', to: 'reject1', label: 'Нет'},
            {from: 'measure', to: 'project'},
            {from: 'project', to: 'calc'},
            {from: 'calc', to: 'visual', type: 'optional'},
            {from: 'calc', to: 'send_kp'},
            {from: 'visual', to: 'send_kp'},
            {from: 'send_kp', to: 'decision2'},
            {from: 'decision2', to: 'order', label: 'Да'},
            {from: 'decision2', to: 'reject2', label: 'Нет'},
            {from: 'reject2', to: 'calc'},
            {from: 'order', to: 'blank'},
            {from: 'blank', to: 'contract', type: 'optional'},
            {from: 'blank', to: 'sign'},
            {from: 'contract', to: 'sign'},
            {from: 'sign', to: 'prepay'},
            {from: 'prepay', to: 'decision3'},
            {from: 'prepay', to: 'cash'},
            {from: 'decision3', to: 'check_order', label: 'Да'},
            {from: 'decision3', to: 'wait_pay', label: 'Нет'},
            {from: 'wait_pay', to: 'decision3'},
            {from: 'check_order', to: 'supplier_req'},
            {from: 'supplier_req', to: 'get_invoice'},
            {from: 'get_invoice', to: 'pay_invoice'},
            {from: 'pay_invoice', to: 'materials'},
            {from: 'check_order', to: 'tz'},
            {from: 'tz', to: 'send_tz'},
            {from: 'send_tz', to: 'materials'},
            {from: 'materials', to: 'production'},
            {from: 'production', to: 'control_prod'},
            {from: 'control_prod', to: 'ready'},
            {from: 'ready', to: 'confirm_date'},
            {from: 'confirm_date', to: 'remind_pay'},
            {from: 'confirm_date', to: 'prepare'},
            {from: 'prepare', to: 'delivery'},
            {from: 'delivery', to: 'final_pay'},
            {from: 'final_pay', to: 'act'},
            {from: 'act', to: 'decision4'},
            {from: 'decision4', to: 'review', label: 'Нет'},
            {from: 'decision4', to: 'fix', label: 'Да'},
            {from: 'fix', to: 'decision4'},
            {from: 'review', to: 'close'},
            {from: 'close', to: 'end'},
            {from: 'close', to: 'archive'},
            {from: 'production', to: 'daily_control', type: 'control'},
            {from: 'daily_control', to: 'weekly_control'},
            {from: 'weekly_control', to: 'monthly_control'},
            {from: 'contact', to: 'crm', type: 'data'},
            {from: 'crm', to: 'project', type: 'data'}
        ];
        // Справочник ролей для отображения в подсказке
        const roleNames = {
            'all': 'Все', 'designer': 'Дизайнер', 'admin': 'Администратор', 'owner': 'Руководитель', 'accountant': 'Бухгалтер',
            'external': 'Внешний подрядчик', 'driver': 'Водитель‑логист (замерщик‑монтажник)'
        };
        // Градиенты для разных типов узлов
        const gradients = {
            start: ['#667eea', '#764ba2'], end: ['#667eea', '#764ba2'], decision: ['#f093fb', '#f5576c'],
            action: ['#4facfe', '#00f2fe'], document: ['#43e97b', '#38f9d7'], control: ['#fa709a', '#fee140']
        };
        // Функции для цвета рёбер
        function getEdgeColor(type) {
            if (type === 'optional') return 'rgba(254, 225, 64, 0.8)';
            if (type === 'control') return '#fa709a';
            if (type === 'data') return '#43e97b';
            return '#667eea';
        }
        function getEdgeWidth(type) {
            if (type === 'control') return 2.5;
            return 2;
        }
        function getEdgeDash(type) {
            if (type === 'optional') return '5,5';
            if (type === 'control') return '10,5';
            if (type === 'data') return '3,3';
            return null;
        }
        // Карта узлов для быстрого доступа
        const nodesMap = {};
        nodes.forEach(n => nodesMap[n.id] = n);
        // Размеры узлов
        const dims = {};
        nodes.forEach(n => {
            const charW = 7.0; const minW = 120; const textLength = n.text.length;
            const w = Math.max(minW, textLength * charW + 20);
            const h = n.type === 'decision' ? 60 : (n.type === 'start' || n.type === 'end' ? 50 : 40);
            dims[n.id] = {width: w, height: h};
        });
        // Основной SVG и его размеры
        const svg = d3.select('#mainSvg');
        const width = svg.node().clientWidth; const height = svg.node().clientHeight;
        const viewport = svg.append('g').attr('id', 'viewport');
        const defs = svg.append('defs');
        defs.append('filter').attr('id', 'dropShadow').attr('height', '130%')
            .append('feDropShadow').attr('dx', 0).attr('dy', 2).attr('stdDeviation', 3).attr('flood-color', 'rgba(0,0,0,0.2)');
        Object.keys(gradients).forEach(type => {
            const grad = defs.append('linearGradient').attr('id', 'grad-' + type).attr('x1', '0%').attr('y1', '0%').attr('x2', '100%').attr('y2', '100%');
            grad.append('stop').attr('offset', '0%').attr('stop-color', gradients[type][0]);
            grad.append('stop').attr('offset', '100%').attr('stop-color', gradients[type][1]);
        });
        defs.append('marker').attr('id', 'arrow').attr('viewBox', '0 0 10 10').attr('refX', 10).attr('refY', 5).attr('markerWidth', 6).attr('markerHeight', 6).attr('orient', 'auto-start-reverse')
            .append('path').attr('d', 'M 0 0 L 10 5 L 0 10 z').attr('fill', '#667eea');
        const edgesGroup = viewport.append('g').attr('id', 'edges');
        const nodesGroup = viewport.append('g').attr('id', 'nodes');
        const edgePaths = edgesGroup.selectAll('path').data(edges).enter().append('path').attr('class', 'edge').attr('stroke', d => getEdgeColor(d.type)).attr('stroke-width', d => getEdgeWidth(d.type)).attr('stroke-dasharray', d => getEdgeDash(d.type)).attr('marker-end', 'url(#arrow)');
        const edgeLabels = edgesGroup.selectAll('text.edge-label').data(edges.filter(d => d.label)).enter().append('text').attr('class', 'edge-label').attr('text-anchor', 'middle').attr('dy', -4).text(d => d.label);
        const nodeSelection = nodesGroup.selectAll('g.node').data(nodes).enter().append('g').attr('class', 'node').attr('data-id', d => d.id).attr('transform', d => `translate(${d.x},${d.y})`)
            .on('mouseenter', (event, d) => showTooltip(event, d)).on('mousemove', (event, d) => showTooltip(event, d)).on('mouseleave', hideTooltip).on('click', (event, d) => highlightPath(d.id));
        nodeSelection.each(function(d) {
            const g = d3.select(this); const w = dims[d.id].width; const h = dims[d.id].height;
            if (d.type === 'decision') {
                const points = [[w/2, 0], [w, h/2], [w/2, h], [0, h/2]].map(p => p.join(',')).join(' ');
                g.append('polygon').attr('points', points).attr('fill', `url(#grad-${d.type})`).attr('filter', 'url(#dropShadow)');
            } else if (d.type === 'start' || d.type === 'end') {
                g.append('rect').attr('width', w).attr('height', h).attr('rx', h/2).attr('ry', h/2).attr('fill', `url(#grad-${d.type})`).attr('filter', 'url(#dropShadow)');
            } else {
                g.append('rect').attr('width', w).attr('height', h).attr('rx', 8).attr('ry', 8).attr('fill', `url(#grad-${d.type})`).attr('filter', 'url(#dropShadow)');
            }
            g.append('text').attr('x', w / 2).attr('y', h / 2).attr('dy', '0.35em').attr('text-anchor', 'middle').attr('fill', d.type === 'document' || d.type === 'control' ? '#333' : '#fff').attr('font-size', 12).text(d.text);
        });

        // --- КОД ДЛЯ ПЕРЕТАСКИВАНИЯ УЗЛОВ ---
        function dragstarted(event, d) {
            event.sourceEvent.stopPropagation();
            d3.select(this).raise().style('cursor', 'grabbing');
        }
        function dragged(event, d) {
            d.x = event.x; d.y = event.y;
            d3.select(this).attr('transform', `translate(${d.x},${d.y})`);
            updateEdges();
            updateMinimapNodes();
        }
        function dragended(event, d) {
            d3.select(this).style('cursor', 'pointer');
        }
        const dragHandler = d3.drag().on("start", dragstarted).on("drag", dragged).on("end", dragended);
        nodeSelection.call(dragHandler);
        function updateMinimapNodes() {
            miniNodes.selectAll('circle')
                .attr('cx', d => { const pos = toMiniCoords(d.x + dims[d.id].width / 2, d.y + dims[d.id].height / 2); return pos.x; })
                .attr('cy', d => { const pos = toMiniCoords(d.x + dims[d.id].width / 2, d.y + dims[d.id].height / 2); return pos.y; });
        }
        // --- КОНЕЦ КОДА ДЛЯ ПЕРЕТАСКИВАНИЯ ---

        function updateEdges() {
            edgePaths.attr('d', d => {
                const from = nodesMap[d.from]; const to = nodesMap[d.to]; const fromDim = dims[d.from]; const toDim = dims[d.to];
                const startX = from.x + fromDim.width; const startY = from.y + fromDim.height / 2;
                const endX = to.x; const endY = to.y + toDim.height / 2;
                const cp1x = startX + 60; const cp1y = startY; const cp2x = endX - 60; const cp2y = endY;
                return `M${startX},${startY} C${cp1x},${cp1y} ${cp2x},${cp2y} ${endX},${endY}`;
            });
            edgePaths.attr('stroke', d => getEdgeColor(d.type)); edgePaths.attr('stroke-dasharray', d => getEdgeDash(d.type) || null); edgePaths.attr('stroke-width', d => getEdgeWidth(d.type));
            edgeLabels
                .attr('x', d => { const from = nodesMap[d.from]; const to = nodesMap[d.to]; const fromDim = dims[d.from]; return (from.x + fromDim.width + to.x) / 2; })
                .attr('y', d => { const from = nodesMap[d.from]; const to = nodesMap[d.to]; const fromDim = dims[d.from]; const toDim = dims[d.to]; return (from.y + fromDim.height / 2 + to.y + toDim.height / 2) / 2 - 8; });
        }
        updateEdges();
        function isReachable(srcId, dstId) {
            if (srcId === dstId) return true;
            const outgoing = edges.filter(e => e.from === srcId);
            for (const e of outgoing) { if (isReachable(e.to, dstId)) return true; }
            return false;
        }
        function highlightPath(targetId) {
            nodeSelection.classed('highlight', d => isReachable('start', d.id) && isReachable(d.id, targetId));
            edgePaths.classed('highlight', d => isReachable('start', d.from) && isReachable(d.to, targetId));
        }
        const tooltip = document.getElementById('tooltip');
        function showTooltip(event, node) {
            if (!node.details) return;
            tooltip.innerHTML = `<strong>${node.text}</strong><br><small style="color:#aaa;">Роль: ${roleNames[node.role]}</small><br><div style="margin-top:8px;">${node.details}</div>`;
            tooltip.style.left = event.pageX + 15 + 'px'; tooltip.style.top = event.pageY + 15 + 'px';
            tooltip.classList.add('show');
        }
        function hideTooltip() { tooltip.classList.remove('show'); }
        let activeRole = 'all';
        function filterByRole(role) {
            activeRole = role;
            document.querySelectorAll('.controls [data-role]').forEach(btn => { btn.classList.toggle('active', btn.getAttribute('data-role') === role); });
            nodeSelection.style('opacity', d => (role === 'all' || d.role === role || d.role === 'all') ? 1 : 0.2).style('pointer-events', d => (role === 'all' || d.role === role || d.role === 'all') ? 'auto' : 'none');
            edgePaths.style('opacity', d => { if (role === 'all') return 1; const fromRole = nodesMap[d.from].role; const toRole = nodesMap[d.to].role; return (fromRole === role || fromRole === 'all' || toRole === role || toRole === 'all') ? 1 : 0.1; });
            edgeLabels.style('opacity', d => { if (role === 'all') return 1; const fromRole = nodesMap[d.from].role; const toRole = nodesMap[d.to].role; return (fromRole === role || fromRole === 'all' || toRole === role || toRole === 'all') ? 1 : 0.1; });
        }
        function updateStats() {
            const total = nodes.length; const control = nodes.filter(n => n.type === 'control').length; const documents = nodes.filter(n => n.type === 'document').length;
            document.getElementById('stats').innerHTML = `<strong>Статистика процесса</strong><br>Всего узлов: ${total}<br>Точек контроля: ${control}<br>Документов: ${documents}<br>Срок процесса: 15–30 дней`;
        }
        updateStats();
        const miniSvg = d3.select('#minimapSvg');
        const miniWidth = miniSvg.node().clientWidth; const miniHeight = miniSvg.node().clientHeight;
        const miniGroup = miniSvg.append('g'); const miniEdges = miniGroup.append('g'); const miniNodes = miniGroup.append('g');
        const miniViewport = miniSvg.append('rect').attr('fill', 'none').attr('stroke', '#f5576c').attr('stroke-width', 2);
        let graphMinX = Infinity, graphMaxX = -Infinity, graphMinY = Infinity, graphMaxY = -Infinity;
        nodes.forEach(n => {
            const w = dims[n.id].width; const h = dims[n.id].height;
            graphMinX = Math.min(graphMinX, n.x); graphMaxX = Math.max(graphMaxX, n.x + w);
            graphMinY = Math.min(graphMinY, n.y); graphMaxY = Math.max(graphMaxY, n.y + h);
        });
        const graphWidth = graphMaxX - graphMinX; const graphHeight = graphMaxY - graphMinY;
        const scaleX = (miniWidth - 20) / graphWidth; const scaleY = (miniHeight - 20) / graphHeight;
        const miniScale = Math.min(scaleX, scaleY);
        const miniOffsetX = (miniWidth - graphWidth * miniScale) / 2; const miniOffsetY = (miniHeight - graphHeight * miniScale) / 2;
        function toMiniCoords(x, y) { return { x: (x - graphMinX) * miniScale + miniOffsetX, y: (y - graphMinY) * miniScale + miniOffsetY }; }
        miniEdges.selectAll('line').data(edges).enter().append('line')
            .attr('x1', d => { const from = nodesMap[d.from]; const pos = toMiniCoords(from.x + dims[d.from].width / 2, from.y + dims[d.from].height / 2); return pos.x; })
            .attr('y1', d => { const from = nodesMap[d.from]; const pos = toMiniCoords(from.x + dims[d.from].width / 2, from.y + dims[d.from].height / 2); return pos.y; })
            .attr('x2', d => { const to = nodesMap[d.to]; const pos = toMiniCoords(to.x + dims[d.to].width / 2, to.y + dims[d.to].height / 2); return pos.x; })
            .attr('y2', d => { const to = nodesMap[d.to]; const pos = toMiniCoords(to.x + dims[d.to].width / 2, to.y + dims[d.to].height / 2); return pos.y; })
            .attr('stroke', '#a9a9a9').attr('stroke-width', 1);
        miniNodes.selectAll('circle').data(nodes).enter().append('circle')
            .attr('cx', d => { const pos = toMiniCoords(d.x + dims[d.id].width / 2, d.y + dims[d.id].height / 2); return pos.x; })
            .attr('cy', d => { const pos = toMiniCoords(d.x + dims[d.id].width / 2, d.y + dims[d.id].height / 2); return pos.y; })
            .attr('r', 4).attr('fill', d => gradients[d.type][0]);
        let currentTransform = d3.zoomIdentity;
        function updateMinimap() {
            const viewGraphWidth = width / currentTransform.k; const viewGraphHeight = height / currentTransform.k;
            const graphX = (-currentTransform.x) / currentTransform.k; const graphY = (-currentTransform.y) / currentTransform.k;
            const miniX = (graphX - graphMinX) * miniScale + miniOffsetX; const miniY = (graphY - graphMinY) * miniScale + miniOffsetY;
            const miniW = viewGraphWidth * miniScale; const miniH = viewGraphHeight * miniScale;
            miniViewport.attr('x', miniX).attr('y', miniY).attr('width', miniW).attr('height', miniH);
        }
        const zoom = d3.zoom().scaleExtent([0.3, 3]).on('start', () => svg.classed('dragging', true)).on('end', () => svg.classed('dragging', false))
            .on('zoom', (event) => { currentTransform = event.transform; viewport.attr('transform', currentTransform); updateMinimap(); updateZoomLabel(); });
        svg.call(zoom);
        function updateZoomLabel() { document.getElementById('zoomLabel').textContent = Math.round(currentTransform.k * 100) + '%'; }
        function resetView() { svg.transition().duration(500).call(zoom.transform, d3.zoomIdentity); }
        function zoomIn() { svg.transition().duration(300).call(zoom.scaleBy, 1.2); }
        function zoomOut() { svg.transition().duration(300).call(zoom.scaleBy, 0.8); }
        let animationEnabled = false; let animationTimer = null;
        function toggleAnimation() {
            animationEnabled = !animationEnabled;
            const btn = document.getElementById('animBtn');
            btn.classList.toggle('active', animationEnabled);
            if (animationEnabled) {
                let t = 0;
                animationTimer = d3.timer(() => {
                    t += 0.01;
                    edgePaths.filter(d => !d.type).attr('stroke', d => {
                        const from = nodesMap[d.from];
                        const hue = (t * 100 + from.x / 10) % 360;
                        return d3.hsl(hue, 0.7, 0.5).toString();
                    });
                });
            } else if (animationTimer) {
                animationTimer.stop(); animationTimer = null;
                edgePaths.filter(d => !d.type).attr('stroke', d => getEdgeColor(d.type));
            }
        }
        document.getElementById('resetBtn').addEventListener('click', resetView);
        document.getElementById('zoomInBtn').addEventListener('click', zoomIn);
        document.getElementById('zoomOutBtn').addEventListener('click', zoomOut);
        document.getElementById('animBtn').addEventListener('click', toggleAnimation);
        document.querySelectorAll('.controls [data-role]').forEach(btn => { btn.addEventListener('click', () => filterByRole(btn.getAttribute('data-role'))); });
        updateMinimap(); updateZoomLabel(); filterByRole('all');
    })();
    </script>
</body>
</html>